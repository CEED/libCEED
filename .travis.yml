language: c

os:
  - linux
  - osx

dist: xenial

osx_image: xcode10.2

compiler:
  - gcc
  - clang

addons:
  apt:
    update: true
    packages:
    - gfortran
    - liblapack-dev
    - libopenblas-dev
    - valgrind-dbg
    - lcov
  homebrew:
    packages:
    - ccache
    - gcc
    - lapack
    - openblas

env:
  - FC=gfortran PETSC_VER=73f49a0

install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        export PATH="/usr/local/opt/ccache/libexec:$PATH"
        && brew link --overwrite gcc;
    fi
# OCCA
  - git clone --depth 1 https://github.com/libocca/occa.git;
  - make -C occa -j2
  - export OCCA_DIR=$PWD/occa
# libXSMM
  - git clone https://github.com/hfp/libxsmm.git;
  - cd libxsmm && git reset --hard 07e360a && cd ..; # Workaround for LIBXSM bug
  - make -C libxsmm -j2
  - export XSMM_DIR=$PWD/libxsmm
# MFEM
  - git clone --depth 1 https://github.com/mfem/mfem.git;
  - make -C mfem -j2 serial CXXFLAGS="-O -std=c++11"
  - export MFEM_DIR=$PWD/mfem
# Nek5k
  - git clone --depth 1 https://github.com/Nek5000/Nek5000.git;
  - cd Nek5000/tools && ./maketools genbox genmap reatore2 && cd ../..;
  - export NEK5K_DIR=$PWD/Nek5000 PATH=$PWD/Nek5000/bin:$PATH MPI=0;
# PETSc
  - export PETSC_INSTALL=$HOME/install/petsc-$PETSC_VER
  - test -s "$PETSC_INSTALL/lib/pkgconfig/PETSc.pc"
        || ( rm -rf $HOME/install/petsc*
        && git clone https://github.com/petsc/petsc.git
        && cd petsc
        && git reset --hard $PETSC_VER
        && ./configure --with-debugging=0 COPTFLAGS=-O --with-mpi=0 --with-fc=0 --with-cxx=0 --prefix=$PETSC_INSTALL
        && make
        && make install )
  - export PETSC_DIR=$PETSC_INSTALL

script:
  - export COVERAGE=1
  - make -j2
  - make -j2 prove-all PROVE_OPTS=-v
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
        clang-tidy --version && make -j2 tidy;
    fi

after_success:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
        lcov --directory . --capture --output-file coverage.info
        && bash <(curl -s https://codecov.io/bash) -f coverage.info -F interface
        && bash <(curl -s https://codecov.io/bash) -f coverage.info -F backends
        && bash <(curl -s https://codecov.io/bash) -f coverage.info -F tests
        && bash <(curl -s https://codecov.io/bash) -f coverage.info -F examples;
    fi

cache:
  ccache: true
  directories:
  - $HOME/install
  - $HOME/Library/Caches/Homebrew
